<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FotoSlide 9+1</title>
<style>
  :root{
    --bg:#0f141b; --panel:#121a23; --muted:#9fb3c9; --tile:#101722;
    --accent:#6ab0ff; --grid:rgba(230,238,247,.18);
    --gap:4px; --radius-cell:8px; --radius-board:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:680px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  h1{font-size:20px;margin:0}
  .controls-top{display:flex;gap:8px;flex-wrap:wrap}
  button,label.btn{background:var(--panel);color:#e6eef7;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:10px;cursor:pointer}
  button[disabled],label.btn.disabled{opacity:.5;cursor:not-allowed}
  button:hover,label.btn:hover{border-color:rgba(255,255,255,.25)}
  input[type=file]{display:none}
  .counter{min-width:48px;text-align:center;padding:8px 12px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:rgba(255,255,255,.05);font-weight:700}

  .stage{position:relative;width:100%;max-width:460px;margin:16px auto 10px}
  .board-wrap{position:relative;width:100%;aspect-ratio:1/1}
  .board{
    position:absolute; inset:0;
    display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr);
    gap:var(--gap); padding:calc(var(--gap) - 1px);
    background:linear-gradient(180deg,#0b1118,#0e1722);
    border:1px solid rgba(255,255,255,.05); border-radius:var(--radius-board);
  }
  .cell{
    border-radius:var(--radius-cell);
    border:1px solid rgba(255,255,255,.06);
    background:var(--tile);
    background-repeat:no-repeat;
    background-size:300% 300%;
    image-rendering:crisp-edges;
    will-change:transform;
    transition:box-shadow .12s ease, background-color .12s ease;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;         /* para recortar el vídeo dentro */
    touch-action:none;
  }
  .cell.movable{ box-shadow:0 0 0 2px var(--accent) inset }
  .grid-overlay{ position:absolute; inset:calc(var(--gap) - 1px); pointer-events:none }
  .gline{ position:absolute; background:var(--grid); border-radius:1px }
  .gv1{ top:0; bottom:0; left:calc(33.333% - .5px); width:1px }
  .gv2{ top:0; bottom:0; left:calc(66.666% - .5px); width:1px }
  .gh1{ left:0; right:0; top:calc(33.333% - .5px); height:1px }
  .gh2{ left:0; right:0; top:calc(66.666% - .5px); height:1px }

  .bottom-bar{width:100%;max-width:460px;margin:var(--gap) auto 0;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .controls-bottom{display:flex;gap:8px;flex-wrap:wrap}
  .dock{
    position:relative; border-radius:var(--radius-cell);
    border:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg,#0b1118,#0e1722);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .dock .cell{ width:100%; height:100%; border:none; border-radius:var(--radius-cell) }

  .toast{
    position:absolute; left:50%; top:10px; transform:translateX(-50%);
    padding:8px 12px; border-radius:10px;
    background:rgba(0,0,0,.35); backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.18);
    font-weight:700; opacity:0; pointer-events:none; transition:opacity .25s ease;
  }
  .toast.show{ opacity:1 }

  /* VIDEO: estilo del video dentro de cada celda (recortado por posición) */
  .tileVideo{
    width:300%; height:300%;        /* equivalente a background-size:300% 300% */
    object-fit:cover;
    pointer-events:none;             /* no “roba” el click de la celda */
    transform-origin:top left;       /* lo veremos con translate() */
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FotoSlide 9+1</h1>
    <div class="controls-top">
      <label for="fileInput" class="btn" id="loadBtn">Cargar foto / vídeo</label>
    </div>
    <div class="counter" id="moves">0</div>
  </header>

  <div class="stage">
    <div class="board-wrap">
      <div id="board" class="board"></div>
      <div class="grid-overlay">
        <div class="gline gv1"></div><div class="gline gv2"></div>
        <div class="gline gh1"></div><div class="gline gh2"></div>
      </div>
      <div class="toast" id="toast">¡Resuelto!</div>
    </div>

    <div class="bottom-bar">
      <div class="controls-bottom">
        <button id="showBtn" disabled>Mostrar</button>
        <button id="shuffleBtn" disabled>Mezclar</button>
      </div>
      <div id="dock" class="dock" title="Muelle (hueco externo)"></div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="image/*,video/*">
</div>

<script>
  const EMPTY = -1;
  let pos = [0,1,2,3,4,5,6,7,8, EMPTY];
  let moves = 0;
  let mediaURL = null;
  let mediaType = null;   // 'image' | 'video'
  let imageReady = false;

  // VIDEO: maestro oculto y control boomerang
  let masterVideo = null;
  let boomStart = 0, boomEnd = 3;    // 0..3s
  let boomReverse = false;
  let rafId = null;

  const boardEl   = document.getElementById('board');
  const dockEl    = document.getElementById('dock');
  const movesEl   = document.getElementById('moves');
  const fileInput = document.getElementById('fileInput');
  const shuffleBtn= document.getElementById('shuffleBtn');
  const showBtn   = document.getElementById('showBtn');
  const toastEl   = document.getElementById('toast');

  let showing = false;
  let savedPos = null;

  const neighbors = {
    0:[1,3], 1:[0,2,4], 2:[1,5],
    3:[0,4,6], 4:[1,3,5,7], 5:[2,4,8],
    6:[3,7], 7:[4,6,8],
    8:[5,7,9], 9:[8]
  };

  function sizeDockToCell(){
    const firstCell = boardEl.querySelector('.cell');
    if(!firstCell) return;
    const r = firstCell.getBoundingClientRect();
    dockEl.style.width  = r.width  + 'px';
    dockEl.style.height = r.height + 'px';
  }
  function safeRender(){ render(); sizeDockToCell(); }

  function cellBackground(el, indexValue){
    // Para IMAGEN: mapea 0..8 a posiciones 0/50/100
    const cx = indexValue % 3, cy = Math.floor(indexValue/3);
    const px = cx===0? '0%' : (cx===1? '50%' : '100%');
    const py = cy===0? '0%' : (cy===1? '50%' : '100%');
    el.style.backgroundImage = `url(${mediaURL})`;
    el.style.backgroundPosition = `${px} ${py}`;
  }

  function createTileVideo(indexValue){
    // Crea un <video> que muestra la parte correspondiente del cuadro
    const v = document.createElement('video');
    v.className = 'tileVideo';
    v.src = mediaURL;
    v.muted = true; v.playsInline = true; v.autoplay = true; v.loop = false; // loop lo hacemos con boomerang
    // Posicionamiento: traducimos -0%, -50% o -100% para encajar
    const cx = indexValue % 3, cy = Math.floor(indexValue/3);
    const tx = cx===0? '0%' : (cx===1? '50%' : '100%');
    const ty = cy===0? '0%' : (cy===1? '50%' : '100%');
    // Convertimos a números y les ponemos signo negativo (equivale a background-position)
    const nx = cx===0? 0 : (cx===1? 0.5 : 1);
    const ny = cy===0? 0 : (cy===1? 0.5 : 1);
    v.style.transform = `translate(${-nx*100}%, ${-ny*100}%)`;
    // Sincronía: al reproducir, lo “engancha” al maestro (si existe)
    v.addEventListener('loadedmetadata', ()=> {
      if (masterVideo) v.currentTime = masterVideo.currentTime;
      v.play().catch(()=>{});
    });
    return v;
  }

  function render(){
    boardEl.innerHTML = '';
    dockEl.innerHTML = '';

    const emptyPos = pos.indexOf(EMPTY);

    for(let i=0;i<9;i++){
      const val = pos[i];
      const cell = document.createElement('div');
      cell.className = 'cell';

      if(val === EMPTY){
        cell.style.background = 'rgba(255,255,255,.03)';
        cell.style.outline = '1px dashed rgba(255,255,255,.12)';
        cell.style.outlineOffset = '-6px';
      } else if(imageReady && mediaURL){
        if(mediaType === 'image'){
          cellBackground(cell, val);
        } else {
          const vid = createTileVideo(val);
          cell.appendChild(vid);
        }
      }

      if(neighbors[i].includes(emptyPos)) cell.classList.add('movable');
      attachSlideHandlers(cell, i);
      boardEl.appendChild(cell);
    }

    const v9 = pos[9];
    const dockCell = document.createElement('div');
    dockCell.className = 'cell';
    if(v9 !== EMPTY && imageReady && mediaURL){
      if(mediaType === 'image'){
        cellBackground(dockCell, v9);
      } else {
        const vid = createTileVideo(v9);
        dockCell.appendChild(vid);
      }
    } else {
      dockCell.style.background = 'rgba(255,255,255,.03)';
      dockCell.style.outline = '1px dashed rgba(255,255,255,.12)';
      dockCell.style.outlineOffset = '-6px';
    }
    attachSlideHandlers(dockCell, 9);
    dockEl.appendChild(dockCell);
  }

  // Animación ligera (mueve la celda real)
  function animateSlide(fromPos, toPos, onDone){
    const cells = boardEl.querySelectorAll('.cell');
    const originEl = (fromPos===9)? dockEl.querySelector('.cell') : cells[fromPos];
    const targetEl = (toPos===9)? dockEl.querySelector('.cell') : cells[toPos];
    if(!originEl || !targetEl){ onDone(); return; }

    const o = originEl.getBoundingClientRect();
    const t = targetEl.getBoundingClientRect();
    const dx = t.left - o.left;
    const dy = t.top  - o.top;

    originEl.style.transition = 'transform .12s ease-out';
    originEl.style.transform = `translate(${dx}px, ${dy}px)`;
    requestAnimationFrame(()=>{
      setTimeout(()=>{
        originEl.style.transition=''; originEl.style.transform='';
        onDone();
      },130);
    });
  }

  function trySlide(fromPos){
    if(!imageReady || showing) return;
    const emptyPos = pos.indexOf(EMPTY);
    if(!neighbors[fromPos].includes(emptyPos)) return;
    animateSlide(fromPos, emptyPos, ()=>{
      [pos[fromPos], pos[emptyPos]] = [pos[emptyPos], pos[fromPos]];
      moves++; movesEl.textContent = moves;
      safeRender(); checkWin();
      if(navigator.vibrate) navigator.vibrate(15);
    });
  }

  function attachSlideHandlers(el, posIndex){
    el.addEventListener('click', ()=>trySlide(posIndex));
    let startX=0,startY=0,tracking=false;
    const start = (x,y)=>{ tracking=true; startX=x; startY=y; };
    const move  = (x,y)=>{
      if(!tracking) return;
      const dx=x-startX, dy=y-startY;
      const emptyPos = pos.indexOf(EMPTY);
      if(!neighbors[posIndex].includes(emptyPos)) return;
      if(Math.abs(dx)>12 || Math.abs(dy)>12){ trySlide(posIndex); tracking=false; }
    };
    const end=()=>{ tracking=false; };
    el.addEventListener('mousedown', e=>start(e.clientX,e.clientY));
    window.addEventListener('mousemove', e=>move(e.clientX,e.clientY));
    window.addEventListener('mouseup', end);
    el.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; start(t.clientX,t.clientY); },{passive:false});
    el.addEventListener('touchmove',  e=>{ const t=e.changedTouches[0]; move(t.clientX,t.clientY); },{passive:false});
    el.addEventListener('touchend', end);
    el.addEventListener('touchcancel', end);
  }

  function isSolved(){ for(let i=0;i<9;i++) if(pos[i]!==i) return false; return pos[9]===EMPTY; }
  function showToast(){ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 1600); }
  function checkWin(){ const win = imageReady && isSolved(); if(win){ showToast(); if(navigator.vibrate) navigator.vibrate([20,60,20]); } }

  function moveEmptyToDock(maxSteps=80){
    let e = pos.indexOf(EMPTY);
    if (e === -1) { pos[9]=EMPTY; return; }
    let last=-1, steps=0;
    while(e!==9 && steps<maxSteps){
      const neigh = neighbors[e] || [];
      if(!neigh.length) break;
      const next = neigh.includes(9) ? 9 : (neigh.find(n=>n!==last) ?? neigh[0]);
      [pos[next], pos[e]] = [pos[e], pos[next]];
      last=e; e=next; steps++;
    }
  }

  function shuffle(times=160){
    if(!imageReady) return;
    pos = [0,1,2,3,4,5,6,7,8, EMPTY];
    let last = -1;
    for(let k=0;k<times;k++){
      const e = pos.indexOf(EMPTY);
      const neigh = neighbors[e] || [];
      if(!neigh.length) break;
      const cands = neigh.filter(n=>n!==last);
      const pick = cands[Math.floor(Math.random()*cands.length)];
      [pos[pick], pos[e]] = [pos[e], pos[pick]];
      last = e;
    }
    if(pos.indexOf(EMPTY)===-1) pos[9]=EMPTY;
    moveEmptyToDock();
    moves=0; movesEl.textContent=moves;
    safeRender(); checkWin();
  }

  // IMAGEN: recorte cuadrado y resize adaptativo
  async function loadImage(file){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.decoding = 'async';
      img.onload = ()=>{
        const side = Math.min(img.width, img.height);
        const sx = Math.floor((img.width - side)/2);
        const sy = Math.floor((img.height - side)/2);
        const dpr = Math.min(2.5, window.devicePixelRatio||1);
        let base = 900; if (window.devicePixelRatio >= 2) base = 1100;
        const size = Math.min(base * dpr, 1400);
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, sx, sy, side, side, 0, 0, size, size);
        resolve(canvas.toDataURL('image/jpeg', 0.9));
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  // VIDEO: prepara maestro, boomerang y arranque
  function setupMasterVideo(url){
    if (masterVideo) { cancelAnimationFrame(rafId); masterVideo.pause(); masterVideo.remove(); }
    masterVideo = document.createElement('video');
    masterVideo.src = url; masterVideo.muted = true; masterVideo.playsInline = true;
    masterVideo.style.display = 'none';
    document.body.appendChild(masterVideo);

    masterVideo.addEventListener('loadedmetadata', ()=>{
      boomEnd = Math.min(3, masterVideo.duration || 3);
      masterVideo.currentTime = 0;
      masterVideo.play().catch(()=>{});
      boomReverse = false;
      tickBoomerang();
    });
  }

  function tickBoomerang(){
    // Actualiza tiempo del maestro y sincroniza clones
    const step = 1/60; // ~16ms
    if (!boomReverse){
      masterVideo.currentTime += step;
      if (masterVideo.currentTime >= boomEnd){ masterVideo.currentTime = boomEnd; boomReverse = true; }
    } else {
      masterVideo.currentTime -= step;
      if (masterVideo.currentTime <= boomStart){ masterVideo.currentTime = boomStart; boomReverse = false; }
    }
    // Sincroniza visibles (9+1 vídeos)
    const vids = document.querySelectorAll('.tileVideo');
    vids.forEach(v => { if (Math.abs(v.currentTime - masterVideo.currentTime) > 0.04) v.currentTime = masterVideo.currentTime; });

    rafId = requestAnimationFrame(tickBoomerang);
  }

  // Cargar archivo (imagen o video)
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      if (file.type.startsWith('video/')){
        mediaType = 'video';
        mediaURL = URL.createObjectURL(file);
        setupMasterVideo(mediaURL);             // VIDEO
      } else {
        mediaType = 'image';
        mediaURL = await loadImage(file);       // IMAGEN
      }
      imageReady = true;
      shuffleBtn.disabled = false;
      showBtn.disabled    = false;
      pos = [0,1,2,3,4,5,6,7,8, EMPTY];
      moves = 0; movesEl.textContent = moves;
      safeRender(); shuffle(160);
    }catch(err){ console.error(err); }
  });

  // Mezclar
  document.getElementById('shuffleBtn').addEventListener('click', ()=>shuffle(140));

  // Mostrar (pista)
  function showFullImage(){
    if(!imageReady || showing) return;
    savedPos = pos.slice(); showing = true;
    pos = [0,1,2,3,4,5,6,7,8, EMPTY];
    safeRender();
  }
  function hideFullImage(){
    if(!showing) return;
    showing = false; pos = savedPos.slice(); safeRender();
  }
  showBtn.addEventListener('mousedown', showFullImage);
  showBtn.addEventListener('mouseup', hideFullImage);
  showBtn.addEventListener('mouseleave', hideFullImage);
  showBtn.addEventListener('touchstart', e=>{ e.preventDefault(); showFullImage(); }, {passive:false});
  showBtn.addEventListener('touchend', hideFullImage);
  showBtn.addEventListener('touchcancel', hideFullImage);

  // Render inicial y alineación muelle
  safeRender();
  window.addEventListener('resize', sizeDockToCell);
</script>
</body>
</html>
