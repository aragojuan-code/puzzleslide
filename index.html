<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FotoSlide 9+1</title>
<style>
  :root{
    --bg:#0f141b; --panel:#121a23; --muted:#9fb3c9; --tile:#101722;
    --accent:#6ab0ff; --grid:rgba(230,238,247,.18);
    --gap:4px; --radius-cell:8px; --radius-board:12px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:680px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  h1{font-size:20px;margin:0}
  .controls-top{display:flex;gap:8px;flex-wrap:wrap}
  button,label.btn{background:var(--panel);color:#e6eef7;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:10px;cursor:pointer}
  button[disabled],label.btn.disabled{opacity:.5;cursor:not-allowed}
  button:hover,label.btn:hover{border-color:rgba(255,255,255,.25)}
  input[type=file]{display:none}
  .counter{min-width:48px;text-align:center;padding:8px 12px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:rgba(255,255,255,.05);font-weight:700}

  .stage{position:relative;width:100%;max-width:460px;margin:16px auto 10px}
  .board-wrap{position:relative;width:100%;aspect-ratio:1/1}
  .board{
    position:absolute; inset:0;
    display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr);
    gap:var(--gap); padding:calc(var(--gap) - 1px);
    background:linear-gradient(180deg,#0b1118,#0e1722);
    border:1px solid rgba(255,255,255,.05); border-radius:var(--radius-board);
  }
  .cell{
    border-radius:var(--radius-cell);
    border:1px solid rgba(255,255,255,.06);
    background:var(--tile);
    background-repeat:no-repeat;
    background-size:300% 300%;
    image-rendering:crisp-edges;
    will-change:transform;
    transition:box-shadow .12s ease, background-color .12s ease;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
    touch-action:none;
  }
  .cell.movable{ box-shadow:0 0 0 2px var(--accent) inset }

  .grid-overlay{ position:absolute; inset:calc(var(--gap) - 1px); pointer-events:none }
  .gline{ position:absolute; background:var(--grid); border-radius:1px }
  .gv1{ top:0; bottom:0; left:calc(33.333% - .5px); width:1px }
  .gv2{ top:0; bottom:0; left:calc(66.666% - .5px); width:1px }
  .gh1{ left:0; right:0; top:calc(33.333% - .5px); height:1px }
  .gh2{ left:0; right:0; top:calc(66.666% - .5px); height:1px }

  .bottom-bar{width:100%;max-width:460px;margin:var(--gap) auto 0;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .controls-bottom{display:flex;gap:8px;flex-wrap:wrap}
  .dock{
    position:relative; border-radius:var(--radius-cell);
    border:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg,#0b1118,#0e1722);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .dock .cell{ width:100%; height:100%; border:none; border-radius:var(--radius-cell) }

  #videoCanvas{
    position:absolute; inset:calc(var(--gap) - 1px);
    width:calc(100% - 2*(var(--gap) - 1px));
    height:calc(100% - 2*(var(--gap) - 1px));
    pointer-events:none;
    border-radius:calc(var(--radius-board) - 2px);
  }
  #dockCanvas{
    position:absolute; inset:0;
    width:100%; height:100%;
    pointer-events:none;
    border-radius:var(--radius-cell);
  }

  .toast{
    position:absolute; left:50%; top:10px; transform:translateX(-50%);
    padding:8px 12px; border-radius:10px;
    background:rgba(0,0,0,.35); backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.18);
    font-weight:700; opacity:0; pointer-events:none; transition:opacity .25s ease;
  }
  .toast.show{ opacity:1 }

  /* Monitor de estado */
  .status{position:fixed;right:8px;top:8px;font:12px/1.2 ui-monospace,monospace;color:#9fb3c9;background:#0b1118aa;border:1px solid #223244;border-radius:8px;padding:6px 8px;z-index:9}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FotoSlide 9+1</h1>
    <div class="controls-top">
      <label for="fileInput" class="btn" id="loadBtn">Cargar foto / vídeo</label>
    </div>
    <div class="counter" id="moves">0</div>
  </header>

  <div class="stage">
    <div class="board-wrap">
      <div id="board" class="board"></div>
      <canvas id="videoCanvas"></canvas>
      <div class="grid-overlay">
        <div class="gline gv1"></div><div class="gline gv2"></div>
        <div class="gline gh1"></div><div class="gline gh2"></div>
      </div>
      <div class="toast" id="toast">¡Resuelto!</div>
    </div>

    <div class="bottom-bar">
      <div class="controls-bottom">
        <button id="showBtn" disabled>Mostrar</button>
        <button id="shuffleBtn" disabled>Mezclar</button>
      </div>
      <div id="dock" class="dock" title="Muelle (hueco externo)">
        <canvas id="dockCanvas"></canvas>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="image/*,video/*">
</div>

<div class="status" id="status">idle</div>

<script>
/* ==== switches ==== */
const ENABLE_CROSSFADE = false;     // ← ponlo en true cuando todo te vaya ok
const FADE_MS = 250;
const DEFAULT_LOOP = 3.0;

/* ==== helpers/log ==== */
const S = document.getElementById('status');
const log = (...a)=>{ console.log(...a); S.textContent = a.join(' '); };

/* ==== estado ==== */
const EMPTY = -1;
let pos   = [0,1,2,3,4,5,6,7,8, EMPTY];
let moves = 0, ready=false, showing=false, drawingSuspended=false;
let mediaURL=null, mediaType=null, savedPos=null;
let masterVideo=null, rafId=null, headReady=false, LOOP_END=DEFAULT_LOOP;

/* ==== refs DOM ==== */
const boardEl   = document.getElementById('board');
const dockEl    = document.getElementById('dock');
const movesEl   = document.getElementById('moves');
const fileInput = document.getElementById('fileInput');
const loadBtn   = document.getElementById('loadBtn');
const shuffleBtn= document.getElementById('shuffleBtn');
const showBtn   = document.getElementById('showBtn');
const toastEl   = document.getElementById('toast');
const vCanvas   = document.getElementById('videoCanvas');
const vctx      = vCanvas.getContext('2d');
const dCanvas   = document.getElementById('dockCanvas');
const dctx      = dCanvas.getContext('2d');

const neighbors = {
  0:[1,3], 1:[0,2,4], 2:[1,5],
  3:[0,4,6], 4:[1,3,5,7], 5:[2,4,8],
  6:[3,7], 7:[4,6,8],
  8:[5,7,9], 9:[8]
};

/* ==== buffers ==== */
const SRC_SIZE = 640;
const srcCanvas  = document.createElement('canvas');
const sctx       = srcCanvas.getContext('2d', { willReadFrequently:true });
const backCanvas = document.createElement('canvas');
const bctx       = backCanvas.getContext('2d');
const headCanvas = document.createElement('canvas');
const hctx       = headCanvas.getContext('2d');

/* ==== layout ==== */
let layout = null; // { dpr, cells[9], dock }

/* ==== util ==== */
function cellBackground(el, val){
  const col = val % 3, row = (val/3)|0;
  el.style.backgroundImage = `url('${mediaURL}')`;
  el.style.backgroundPosition = `${['0%','50%','100%'][col]} ${['0%','50%','100%'][row]}`;
}
function sizeDockToCell(){
  const first = boardEl.querySelector('.cell');
  if(!first) return;
  const r = first.getBoundingClientRect();
  dockEl.style.width  = r.width  + 'px';
  dockEl.style.height = r.height + 'px';
}
function computeLayout(){
  const dpr = window.devicePixelRatio || 1;
  const rB  = boardEl.getBoundingClientRect();
  const newW = Math.max(1, Math.round(rB.width  * dpr));
  const newH = Math.max(1, Math.round(rB.height * dpr));
  if (vCanvas.width !== newW || vCanvas.height !== newH){
    vCanvas.width  = newW;
    vCanvas.height = newH;
  }
  const cellEls = [...boardEl.querySelectorAll('.cell')].slice(0,9);
  const cells = cellEls.map(el=>{
    const r = el.getBoundingClientRect();
    return { x:Math.round((r.left-rB.left)*dpr), y:Math.round((r.top-rB.top)*dpr),
             w:Math.round(r.width*dpr), h:Math.round(r.height*dpr) };
  });
  const rd = dockEl.getBoundingClientRect();
  const dw = Math.max(1, Math.round(rd.width  * dpr));
  const dh = Math.max(1, Math.round(rd.height * dpr));
  if (dCanvas.width !== dw || dCanvas.height !== dh){ dCanvas.width = dw; dCanvas.height = dh; }
  layout = { dpr, cells, dock:{ x:0,y:0,w:dw,h:dh } };
}
function safeRender(){
  drawingSuspended = true;
  render();
  sizeDockToCell();
  computeLayout();
  requestAnimationFrame(()=>{ drawingSuspended=false; if(mediaType==='video') drawVideoTiles(); });
}

/* ==== render ==== */
function render(){
  boardEl.innerHTML = '';
  dockEl.querySelectorAll('.cell').forEach(n=>n.remove());
  const emptyPos = pos.indexOf(EMPTY);
  for(let i=0;i<9;i++){
    const val = pos[i];
    const cell = document.createElement('div');
    cell.className = 'cell';
    if(val === EMPTY){
      cell.style.background = 'rgba(255,255,255,.03)';
      cell.style.outline = '1px dashed rgba(255,255,255,.12)';
      cell.style.outlineOffset = '-6px';
    } else if(ready && mediaURL && mediaType === 'image'){
      cellBackground(cell, val);
    }
    if(neighbors[i].includes(emptyPos)) cell.classList.add('movable');
    attachSlideHandlers(cell, i);
    boardEl.appendChild(cell);
  }
  const v9 = pos[9];
  const dockCell = document.createElement('div');
  dockCell.className = 'cell';
  if(v9 !== EMPTY){
    if(ready && mediaURL && mediaType==='image'){ cellBackground(dockCell, v9); }
    else { dockCell.style.background='transparent'; }
  }else{
    dockCell.style.background='rgba(255,255,255,.03)';
    dockCell.style.outline='1px dashed rgba(255,255,255,.12)';
    dockCell.style.outlineOffset='-6px';
    dctx.clearRect(0,0,dCanvas.width,dCanvas.height);
  }
  attachSlideHandlers(dockCell, 9);
  dockEl.appendChild(dockCell);
}

/* ==== interacción ==== */
function animateSlide(fromPos,toPos,onDone){
  const cells=boardEl.querySelectorAll('.cell');
  const origin=(fromPos===9)?dockEl.querySelector('.cell'):cells[fromPos];
  const target=(toPos===9)?dockEl.querySelector('.cell'):cells[toPos];
  if(!origin||!target){ onDone(); return; }
  const o=origin.getBoundingClientRect(), t=target.getBoundingClientRect();
  origin.style.transition='transform .12s ease-out';
  origin.style.transform=`translate(${t.left-o.left}px,${t.top-o.top}px)`;
  requestAnimationFrame(()=>{ setTimeout(()=>{ origin.style.transition=''; origin.style.transform=''; onDone(); computeLayout(); if(mediaType==='video') drawVideoTiles(); },130); });
}
function trySlide(fromPos){
  if(!ready||showing) return;
  const emptyPos = pos.indexOf(EMPTY);
  if(!neighbors[fromPos].includes(emptyPos)) return;
  animateSlide(fromPos, emptyPos, ()=>{
    [pos[fromPos], pos[emptyPos]] = [pos[emptyPos], pos[fromPos]];
    moves++; movesEl.textContent=moves;
    safeRender(); checkWin();
    if(navigator.vibrate) navigator.vibrate(15);
  });
}
function attachSlideHandlers(el, posIndex){
  el.addEventListener('click', ()=>trySlide(posIndex));
  let startX=0,startY=0,tracking=false;
  const start=(x,y)=>{tracking=true;startX=x;startY=y;};
  const move=(x,y)=>{ if(!tracking) return; const dx=x-startX, dy=y-startY; const e=pos.indexOf(EMPTY); if(!neighbors[posIndex].includes(e)) return; if(Math.abs(dx)>12||Math.abs(dy)>12){trySlide(posIndex);tracking=false;} };
  const end=()=>{tracking=false;};
  el.addEventListener('mousedown', e=>start(e.clientX,e.clientY));
  window.addEventListener('mousemove', e=>move(e.clientX,e.clientY));
  window.addEventListener('mouseup', end);
  el.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; start(t.clientX,t.clientY); },{passive:false});
  el.addEventListener('touchmove', e=>{ const t=e.changedTouches[0]; move(t.clientX,t.clientY); },{passive:false});
  el.addEventListener('touchend', end);
  el.addEventListener('touchcancel', end);
}

/* ==== win ==== */
function isSolved(){ for(let i=0;i<9;i++) if(pos[i]!==i) return false; return pos[9]===EMPTY; }
function showToast(){ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1600); }
function checkWin(){ if(ready && isSolved()){ showToast(); if(navigator.vibrate) navigator.vibrate([20,60,20]); } }

/* ==== shuffle ==== */
function moveEmptyToDock(maxSteps=80){
  let e=pos.indexOf(EMPTY); if(e===-1){ pos[9]=EMPTY; return; }
  let last=-1,steps=0;
  while(e!==9 && steps<maxSteps){
    const neigh=neighbors[e]||[]; if(!neigh.length) break;
    const next = neigh.includes(9)?9:(neigh.find(n=>n!==last) ?? neigh[0]);
    [pos[next], pos[e]]=[pos[e], pos[next]]; last=e; e=next; steps++;
  }
}
function shuffle(times=160){
  if(!ready) return;
  pos=[0,1,2,3,4,5,6,7,8, EMPTY];
  let last=-1;
  for(let k=0;k<times;k++){
    const e=pos.indexOf(EMPTY), n=neighbors[e]||[]; if(!n.length) break;
    const c=n.filter(x=>x!==last); const pick=c[Math.floor(Math.random()*c.length)];
    [pos[pick], pos[e]]=[pos[e], pos[pick]]; last=e;
  }
  if(pos.indexOf(EMPTY)===-1) pos[9]=EMPTY;
  moveEmptyToDock(); moves=0; movesEl.textContent=moves;
  safeRender(); checkWin();
}

/* ==== imagen ==== */
async function loadImage(file){
  const url = URL.createObjectURL(file);
  try{
    const img=new Image(); img.decoding='async'; img.src=url; await img.decode();
    const side=Math.min(img.width,img.height);
    const sx=((img.width-side)/2)|0, sy=((img.height-side)/2)|0;
    const dpr=Math.min(2.5, window.devicePixelRatio||1);
    const base=(window.devicePixelRatio||1)>=2?1100:900;
    const size=Math.min(base*dpr,1400);
    const c=document.createElement('canvas'); c.width=size; c.height=size;
    c.getContext('2d').drawImage(img,sx,sy,side,side,0,0,size,size);
    return c.toDataURL('image/jpeg',0.9);
  } finally{ URL.revokeObjectURL(url); }
}

/* ==== vídeo ==== */
function setupMasterVideo(url){
  // clean previous
  if(masterVideo){ try{cancelAnimationFrame(rafId);}catch{} try{masterVideo.pause();}catch{} masterVideo.remove(); masterVideo=null; }
  masterVideo=document.createElement('video');
  masterVideo.src=url;
  masterVideo.muted=true;
  masterVideo.playsInline=true;
  masterVideo.setAttribute('playsinline','');
  masterVideo.setAttribute('webkit-playsinline','');
  masterVideo.preload='auto';
  masterVideo.loop=false;
  Object.assign(masterVideo.style,{position:'fixed',left:'-9999px',top:'-9999px',width:'1px',height:'1px',opacity:'0',pointerEvents:'none'});
  document.body.appendChild(masterVideo);

  // head frame buffer
  headCanvas.width=SRC_SIZE; headCanvas.height=SRC_SIZE; headReady=false;

  masterVideo.addEventListener('loadedmetadata', ()=>{
    const dur = Number.isFinite(masterVideo.duration)? masterVideo.duration : DEFAULT_LOOP;
    LOOP_END = Math.max(0.2, Math.min(DEFAULT_LOOP, dur-0.05));
  }, {once:true});

  // en móviles, mejor arrancar el bucle en 'play' (tras gesto)
  masterVideo.addEventListener('play', ()=>{
    if(rafId) cancelAnimationFrame(rafId);
    const tick=()=>{ drawVideoTiles(); rafId=requestAnimationFrame(tick); };
    rafId=requestAnimationFrame(tick);
  }, {once:true});
}

function drawVideoTiles(){
  if(drawingSuspended || !masterVideo || !layout) return;
  const st = masterVideo.readyState;
  if(st < 2) return; // no hay datos suficientes

  // boomerang sencillo sin crossfade (estable)
  if(masterVideo.currentTime >= LOOP_END - 0.02){
    try{ masterVideo.currentTime = 0.01; }catch{}
  }

  const vw=masterVideo.videoWidth, vh=masterVideo.videoHeight; if(!vw||!vh) return;
  const side=Math.min(vw,vh), sx0=((vw-side)/2)|0, sy0=((vh-side)/2)|0;

  if(srcCanvas.width!==SRC_SIZE) srcCanvas.width=SRC_SIZE;
  if(srcCanvas.height!==SRC_SIZE) srcCanvas.height=SRC_SIZE;
  sctx.drawImage(masterVideo,sx0,sy0,side,side,0,0,SRC_SIZE,SRC_SIZE);

  if(backCanvas.width!==vCanvas.width||backCanvas.height!==vCanvas.height){
    backCanvas.width=vCanvas.width; backCanvas.height=vCanvas.height;
  }
  bctx.clearRect(0,0,backCanvas.width,backCanvas.height);

  const ts=SRC_SIZE/3;
  for(let i=0;i<9;i++){
    const val=pos[i]; if(val===EMPTY) continue;
    const {x,y,w,h}=layout.cells[i];
    const cx=val%3, cy=(val/3)|0;
    bctx.drawImage(srcCanvas, cx*ts,cy*ts,ts,ts, x,y,w,h);
  }

  // crossfade opcional
  if(ENABLE_CROSSFADE && headReady){
    const t=masterVideo.currentTime, t0=LOOP_END-FADE_MS/1000;
    if(t>=t0){
      const alpha=Math.min(1,(t-t0)/(FADE_MS/1000));
      bctx.save(); bctx.globalAlpha=alpha;
      for(let i=0;i<9;i++){
        const val=pos[i]; if(val===EMPTY) continue;
        const {x,y,w,h}=layout.cells[i];
        const cx=val%3, cy=(val/3)|0;
        bctx.drawImage(headCanvas,cx*ts,cy*ts,ts,ts,x,y,w,h);
      }
      bctx.restore();
    }
  }

  vctx.clearRect(0,0,vCanvas.width,vCanvas.height);
  vctx.drawImage(backCanvas,0,0);

  // muelle (casilla 10)
  dctx.clearRect(0,0,dCanvas.width,dCanvas.height);
  const v9=pos[9];
  if(v9!==EMPTY){
    const cx=v9%3, cy=(v9/3)|0;
    dctx.drawImage(srcCanvas,cx*ts,cy*ts,ts,ts,0,0,dCanvas.width,dCanvas.height);
  }
}

/* ==== mostrar completa ==== */
function showFullImage(){ if(!ready||showing) return; savedPos=pos.slice(); showing=true; pos=[0,1,2,3,4,5,6,7,8,EMPTY]; safeRender(); if(mediaType==='video') drawVideoTiles(); }
function hideFullImage(){ if(!showing) return; showing=false; pos=savedPos.slice(); safeRender(); if(mediaType==='video') drawVideoTiles(); }
showBtn.addEventListener('mousedown', showFullImage);
showBtn.addEventListener('mouseup', hideFullImage);
showBtn.addEventListener('mouseleave', hideFullImage);
showBtn.addEventListener('touchstart', e=>{ e.preventDefault(); showFullImage(); }, {passive:false});
showBtn.addEventListener('touchend', hideFullImage);
showBtn.addEventListener('touchcancel', hideFullImage);

/* ==== carga archivo ==== */
loadBtn.addEventListener('click', ()=> fileInput.click()); // por si el 'for' fallara en algún navegador
fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    log('cargando', file.type);
    ready=false; drawingSuspended=true;

    // limpiar recursos previos
    if(masterVideo){ try{cancelAnimationFrame(rafId);}catch{} try{masterVideo.pause();}catch{} masterVideo.remove(); masterVideo=null; }
    if(mediaURL && typeof mediaURL==='string' && mediaURL.startsWith('blob:')){ try{URL.revokeObjectURL(mediaURL);}catch{} }

    if(file.type.startsWith('video/')){
      mediaType='video';
      mediaURL=URL.createObjectURL(file);
      setupMasterVideo(mediaURL);

      // Gesto de usuario: intenta play aquí mismo (clave para autoplay mobile)
      await masterVideo.play().catch(()=>{});
      // Captura head para el (posible) crossfade
      masterVideo.currentTime = 0.01;
      masterVideo.addEventListener('seeked', ()=>{
        const vw=masterVideo.videoWidth, vh=masterVideo.videoHeight;
        if(vw&&vh){ const side=Math.min(vw,vh); const sx=((vw-side)/2)|0, sy=((vh-side)/2)|0;
          headCanvas.width=SRC_SIZE; headCanvas.height=SRC_SIZE;
          hctx.drawImage(masterVideo,sx,sy,side,side,0,0,SRC_SIZE,SRC_SIZE);
          headReady=true;
        }
      }, {once:true});
    }else{
      mediaType='image';
      mediaURL=await loadImage(file);
    }

    ready=true;
    shuffleBtn.disabled=false;
    showBtn.disabled=false;
    pos=[0,1,2,3,4,5,6,7,8,EMPTY];
    moves=0; movesEl.textContent=moves;
    drawingSuspended=false;
    safeRender();
    shuffle(160);
    if(mediaType==='video') drawVideoTiles();
    log('ok', mediaType);
  }catch(err){
    console.error(err);
    log('error', err?.message||err);
    alert('Error al cargar: '+(err?.message||err));
  }
});

/* ==== botón mezclar ==== */
shuffleBtn.addEventListener('click', ()=>{
  shuffle(140);
  if(mediaType==='video') drawVideoTiles();
});

/* ==== init ==== */
safeRender();
window.addEventListener('resize', ()=>{ sizeDockToCell(); computeLayout(); if(mediaType==='video') drawVideoTiles(); });
</script>
</body>
</html>
